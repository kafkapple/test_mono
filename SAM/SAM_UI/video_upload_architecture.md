# 웹 앱 영상 업로드 및 결과 추적 시스템 아키텍처 설계

## 1. 시스템 개요

SAM-MOT 객체 추적 시스템의 웹 인터페이스를 확장하여 사용자가 영상을 업로드하고, 처리 결과를 추적할 수 있는 풀스택 웹 애플리케이션을 설계합니다. 이 시스템은 영상 파일 업로드, 메타데이터 관리, SAM-MOT 알고리즘 실행, 결과 저장 및 시각화 기능을 제공합니다.

## 2. 전체 아키텍처 다이어그램

```
+------------------+     +------------------+     +------------------+
|                  |     |                  |     |                  |
|   클라이언트      |     |   웹 서버        |     |   작업 큐        |
|   (React)        |<--->|   (Flask)        |<--->|   (Redis)        |
|                  |     |                  |     |                  |
+------------------+     +------------------+     +------------------+
                               |      ^                   ^
                               |      |                   |
                               v      |                   |
+------------------+     +------------------+     +------------------+
|                  |     |                  |     |                  |
|   데이터베이스    |     |   파일 스토리지   |     |   워커 프로세스   |
|   (MongoDB)      |<--->|   (로컬/S3)      |     |   (SAM-MOT)      |
|                  |     |                  |     |                  |
+------------------+     +------------------+     +------------------+
```

## 3. 컴포넌트 설계

### 3.1 프론트엔드 (React)

#### 주요 컴포넌트:
- **VideoUploadComponent**: 영상 파일 업로드 인터페이스
- **ProcessingDashboard**: 처리 상태 모니터링 및 결과 관리
- **ResultViewer**: 처리된 영상 및 추적 데이터 시각화

#### 데이터 흐름:
1. 사용자가 영상 파일 선택 또는 드래그 앤 드롭
2. 업로드 진행 상태 표시 (프로그레스 바)
3. 업로드 완료 후 처리 상태 모니터링
4. 처리 완료 시 결과 표시 및 다운로드 옵션 제공

### 3.2 백엔드 (Flask)

#### API 엔드포인트:
- **POST /api/videos/upload**: 영상 파일 업로드
- **GET /api/videos**: 업로드된 영상 목록 조회
- **GET /api/videos/{id}**: 특정 영상 메타데이터 조회
- **GET /api/videos/{id}/status**: 처리 상태 조회
- **GET /api/videos/{id}/result**: 처리 결과 조회
- **GET /api/videos/{id}/download**: 결과 영상 다운로드

#### 미들웨어:
- 인증 및 권한 관리 (선택적)
- 요청 검증
- 오류 처리
- 로깅

### 3.3 데이터베이스 (MongoDB)

#### 컬렉션 스키마:

**Videos 컬렉션:**
```json
{
  "_id": "ObjectId",
  "original_filename": "string",
  "storage_path": "string",
  "upload_time": "datetime",
  "file_size": "number",
  "duration": "number",
  "status": "string", // "uploaded", "processing", "completed", "failed"
  "processing_start_time": "datetime",
  "processing_end_time": "datetime",
  "error_message": "string",
  "result_path": "string",
  "user_id": "string" // 선택적
}
```

**TrackingResults 컬렉션:**
```json
{
  "_id": "ObjectId",
  "video_id": "ObjectId",
  "frame_count": "number",
  "fps": "number",
  "objects": [
    {
      "track_id": "number",
      "frames": [
        {
          "frame_id": "number",
          "bbox": [x, y, w, h],
          "mask": "string", // RLE 인코딩된 마스크 또는 경로
          "score": "number"
        }
      ]
    }
  ],
  "performance_metrics": {
    "processing_time": "number",
    "average_fps": "number"
  }
}
```

### 3.4 작업 큐 (Redis)

- 비동기 작업 처리를 위한 메시지 큐
- 작업 우선순위 관리
- 실패한 작업 재시도 메커니즘

### 3.5 워커 프로세스 (SAM-MOT)

- 큐에서 작업을 가져와 처리
- SAM-MOT 알고리즘 실행
- 결과 저장 및 데이터베이스 업데이트
- 처리 상태 및 진행률 업데이트

### 3.6 파일 스토리지

- 원본 영상 저장 디렉토리
- 처리 결과 영상 저장 디렉토리
- 마스크 및 추적 데이터 저장 디렉토리

## 4. 데이터 흐름 설계

### 4.1 영상 업로드 및 처리 흐름

```
1. 클라이언트: 영상 파일 선택 및 업로드 요청
   |
2. 웹 서버: 파일 수신 및 저장, 메타데이터 생성
   |
3. 웹 서버: 데이터베이스에 영상 정보 저장
   |
4. 웹 서버: 처리 작업을 큐에 추가
   |
5. 워커 프로세스: 큐에서 작업 가져오기
   |
6. 워커 프로세스: SAM-MOT 알고리즘 실행
   |
7. 워커 프로세스: 결과 저장 및 데이터베이스 업데이트
   |
8. 클라이언트: 처리 상태 폴링 또는 웹소켓을 통한 실시간 업데이트
   |
9. 클라이언트: 처리 완료 시 결과 표시 및 다운로드 옵션 제공
```

### 4.2 결과 조회 및 다운로드 흐름

```
1. 클라이언트: 처리된 영상 목록 요청
   |
2. 웹 서버: 데이터베이스에서 영상 목록 조회
   |
3. 클라이언트: 특정 영상 결과 요청
   |
4. 웹 서버: 데이터베이스에서 결과 메타데이터 조회
   |
5. 웹 서버: 파일 스토리지에서 결과 영상 및 추적 데이터 조회
   |
6. 클라이언트: 결과 시각화 및 재생
   |
7. 클라이언트: 결과 다운로드 요청 (선택적)
   |
8. 웹 서버: 결과 파일 스트리밍 또는 압축 후 전송
```

## 5. 기술 스택 선정

### 5.1 프론트엔드
- **프레임워크**: React
- **상태 관리**: Redux 또는 Context API
- **UI 라이브러리**: Tailwind CSS, shadcn/ui
- **HTTP 클라이언트**: Axios
- **파일 업로드**: react-dropzone
- **비디오 플레이어**: react-player
- **데이터 시각화**: recharts

### 5.2 백엔드
- **웹 프레임워크**: Flask
- **API 설계**: Flask-RESTful
- **비동기 작업**: Celery
- **파일 처리**: Flask-Uploads
- **인증 (선택적)**: Flask-JWT-Extended

### 5.3 데이터베이스
- **주 데이터베이스**: MongoDB
- **캐싱**: Redis

### 5.4 인프라
- **웹 서버**: Gunicorn
- **리버스 프록시**: Nginx
- **컨테이너화 (선택적)**: Docker
- **클라우드 스토리지 (선택적)**: AWS S3

## 6. 보안 고려사항

- 파일 업로드 검증 및 제한 (파일 크기, 형식 등)
- 입력 데이터 검증
- CSRF 보호
- 인증 및 권한 관리 (선택적)
- 안전한 파일 저장 및 접근 제어
- API 요청 제한 (Rate limiting)

## 7. 확장성 고려사항

- 수평적 확장을 위한 무상태(Stateless) 설계
- 작업 큐를 통한 비동기 처리
- 데이터베이스 인덱싱 및 샤딩
- 클라우드 스토리지 통합 (선택적)
- 마이크로서비스 아키텍처로의 전환 가능성 (선택적)

## 8. 구현 로드맵

### 8.1 1단계: 기본 기능 구현
- 영상 업로드 인터페이스
- 기본 메타데이터 저장
- SAM-MOT 알고리즘 연동
- 결과 저장 및 다운로드

### 8.2 2단계: 핵심 기능 확장
- 처리 상태 모니터링 대시보드
- 객체 추적 데이터 구조화 저장
- 결과 영상 미리보기 및 재생
- 오류 처리 및 복구 메커니즘

### 8.3 3단계: 고급 기능 추가 (선택적)
- 사용자 계정 및 인증 시스템
- 고급 결과 분석 및 시각화 도구
- 결과 공유 기능
- 배치 처리 기능

## 9. 성능 최적화 전략

- 청크 단위 파일 업로드
- 이미지/영상 압축 및 최적화
- 데이터베이스 쿼리 최적화
- 캐싱 전략 구현
- 비동기 및 병렬 처리
- CDN 활용 (선택적)
